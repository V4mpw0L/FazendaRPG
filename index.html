<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#5caa1f" />
  <meta name="description" content="FazendaRPG - Um jogo de fazenda RPG completo para mobile" />

  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FazendaRPG" />
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- iOS Splash Screens -->
  <meta name="apple-touch-fullscreen" content="yes" />

  <title>üåæ FazendaRPG</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="./assets/icon.svg" />
  <link rel="icon" type="image/png" sizes="192x192" href="./assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./assets/icon-512.png" />

  <!-- iOS Icons - iOS n√£o suporta SVG, precisa de PNG -->
  <link rel="apple-touch-icon" href="./assets/icon-152.png" sizes="152x152" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="./assets/icon-384.png" sizes="384x384" />
  <link rel="apple-touch-icon" href="./assets/icon-512.png" sizes="512x512" />

  <!-- Styles -->
  <link rel="stylesheet" href="style/main.css" />
  <link rel="stylesheet" href="style/topbar.css" />
  <link rel="stylesheet" href="style/skills.css" />
  <link rel="stylesheet" href="style/wiki.css" />
  <link rel="stylesheet" href="style/themes.css" />
  <link rel="stylesheet" href="style/mobile.css" />
  <link rel="stylesheet" href="style/topbar-fix.css" />
  <link rel="stylesheet" href="style/components/farm-improvements.css" />
</head>
<body class="light-theme">

  <!-- Top Bar -->
  <div id="topbar" class="topbar">
    <!-- Left Section: Avatar + Player Info -->
    <div class="topbar-left">
      <div class="topbar-avatar" id="topbar-avatar" style="cursor: pointer; overflow: hidden; border-radius: 50%;">
        <img id="topbar-avatar-img" src="assets/sprites/avatars/11.png" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
      <div class="topbar-player">
        <h1 class="topbar-player-name" id="topbar-player-name">Fazendeiro</h1>
        <div class="topbar-player-level">N√≠vel <span id="topbar-level">1</span></div>
        <div class="topbar-farming-xp">
          <div class="topbar-farming-bar">
            <div class="topbar-farming-fill" id="topbar-farming-fill" style="width: 0%"></div>
          </div>
          <div class="topbar-farming-text">
            <span id="topbar-farming-current">0</span>/<span id="topbar-farming-needed">100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats (Gold & Energy) -->
    <div class="topbar-stats">
      <div class="topbar-stat topbar-gold">
        <div class="topbar-stat-header">
          <span class="topbar-stat-icon"><img src="./assets/sprites/ouro.png" alt="Ouro" style="width: 1.2em; height: 1.2em; vertical-align: middle;"></span>
          <span class="topbar-stat-value" id="topbar-gold">0</span>
        </div>
      </div>
      <div class="topbar-stat topbar-energy">
        <div class="topbar-stat-header">
          <span class="topbar-stat-icon">‚ö°</span>
          <span class="topbar-stat-value" id="topbar-energy">0/100</span>
        </div>
        <div class="topbar-energy-bar">
          <div class="topbar-energy-fill" id="topbar-energy-fill" style="width: 100%"></div>
        </div>
      </div>
    </div>

    <!-- Menu Toggle -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Menu">
      <span class="hamburger"></span>
    </button>
  </div>

  <!-- Side Menu -->
  <div id="side-menu" class="side-menu">
    <div class="menu-header">
      <div class="menu-header-content">
        <div class="menu-logo">üåæ</div>
        <div class="menu-title-section">
          <h2 id="menu-title">FazendaRPG</h2>
          <p class="menu-subtitle">Menu Principal</p>
        </div>
      </div>
      <button id="menu-close" class="menu-close">&times;</button>
    </div>

    <nav class="menu-nav">
      <!-- Navega√ß√£o Principal -->
      <div class="menu-section">
        <h3 class="menu-section-title">üéÆ Navega√ß√£o</h3>

        <button class="menu-item" data-page="farm">
          <span class="menu-item-icon">
            <img src="assets/sprites/home.png" alt="Fazenda" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.farm">Fazenda</span>
            <span class="menu-item-desc">Sua planta√ß√£o</span>
          </div>
        </button>

        <button class="menu-item" data-page="skills">
          <span class="menu-item-icon">
            <img src="assets/sprites/skills.png" alt="Skills" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.skills">Skills</span>
            <span class="menu-item-desc">Suas habilidades</span>
          </div>
        </button>

        <button class="menu-item" data-page="inventory">
          <span class="menu-item-icon">
            <img src="assets/sprites/bolsa.png" alt="Invent√°rio" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.inventory">Invent√°rio</span>
            <span class="menu-item-desc">Seus itens</span>
          </div>
        </button>

        <button class="menu-item" data-page="wiki">
          <span class="menu-item-icon"><img src="assets/sprites/wiki.png" alt="Wiki" style="width: 24px; height: 24px;"></span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.wiki">Wiki</span>
            <span class="menu-item-desc">Guia completo</span>
          </div>
        </button>
      </div>

      <!-- Mundo e Intera√ß√µes -->
      <div class="menu-section">
        <h3 class="menu-section-title">üåç Mundo</h3>

        <button class="menu-item" id="news-menu-btn">
          <span class="menu-item-icon"><img src="assets/sprites/noticias.png" alt="Not√≠cias" style="width: 24px; height: 24px;"></span>
          <div class="menu-item-content">
            <span class="menu-item-title">Not√≠cias</span>
            <span class="menu-item-desc">Atualiza√ß√µes</span>
          </div>
        </button>

        <button class="menu-item" data-page="city">
          <span class="menu-item-icon city-icon"><img src="assets/sprites/cidade.png" alt="Cidade" style="width: 24px; height: 24px;"></span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.city">Cidade</span>
            <span class="menu-item-desc">Mercado e mais</span>
          </div>
        </button>

        <button class="menu-item" data-page="quests">
          <span class="menu-item-icon">
            <img src="assets/sprites/quests.png" alt="Miss√µes" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.quests">Miss√µes</span>
            <span class="menu-item-desc">Objetivos</span>
          </div>
        </button>

        <button class="menu-item" data-page="npcs">
          <span class="menu-item-icon">
            <img src="assets/sprites/npcs.png" alt="NPCs" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.npcs">NPCs</span>
            <span class="menu-item-desc">Personagens</span>
          </div>
        </button>
      </div>

      <!-- Configura√ß√µes -->
      <div class="menu-section">
        <h3 class="menu-section-title">‚öôÔ∏è Sistema</h3>

        <button class="menu-item" data-page="settings">
          <span class="menu-item-icon">
            <img src="assets/sprites/settings.png" alt="Configura√ß√µes" style="width: 28px; height: 28px;">
          </span>
          <div class="menu-item-content">
            <span class="menu-item-title" data-i18n="menu.settings">Configura√ß√µes</span>
            <span class="menu-item-desc">Ajustes</span>
          </div>
        </button>
      </div>

    </nav>
  </div>

  <!-- Overlay for menu -->
  <div id="menu-overlay" class="menu-overlay"></div>

  <!-- Main Content -->
  <main id="main-content" class="main-content">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="screen active">
      <div class="welcome-card">
        <h1>üåæ FazendaRPG</h1></h1>
        <p data-i18n="welcome.subtitle">Bem-vindo ao seu RPG de Fazenda!</p>
        <div class="welcome-form">
          <label for="player-name" data-i18n="welcome.name">Digite seu nome:</label>
          <input type="text" id="player-name" maxlength="20" placeholder="Fazendeiro" />
          <button id="start-game-btn" class="btn btn-primary" data-i18n="welcome.start">Come√ßar Aventura</button>
        </div>
        <div class="welcome-version">v0.0.17</div>
      </div>
    </div>

    <!-- Farm Screen -->
    <div id="farm-screen" class="screen">
      <div class="farm-view" id="farm-view">
        <div class="farm-header">
          <div class="farm-welcome-message">
            <button id="farm-inventory-btn" class="farm-inventory-btn" aria-label="Invent√°rio" title="Ir para Invent√°rio">
              <img src="assets/sprites/bolsa.png" alt="Invent√°rio">
            </button>
            <div class="welcome-greeting">
              <span class="welcome-icon" style="width: 48px; height: 48px; display: inline-block; border-radius: 50%; overflow: hidden; border: 2px solid var(--brand-primary); vertical-align: middle;">
                <img id="farm-avatar-img" src="assets/sprites/avatars/11.png" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
              </span>
              <span class="welcome-text">Bem-vindo, <strong id="welcome-player-name">Fazendeiro</strong>!</span>
            </div>
            <h2 class="farm-subtitle" data-i18n="farm.title">Sua Fazenda</h2>
            <div class="farm-player-level">
              <span class="level-badge">
                <span class="level-icon">‚≠ê</span>
                <span class="level-text">N√≠vel <span id="farm-player-level">1</span></span>
              </span>
            </div>
            <p class="welcome-subtitle">üåæ Plante, colha e prospere em sua fazenda! üöú</p>
          </div>
        </div>
        <div class="xp-bar-container" style="display: none;">
          <div class="xp-bar">
            <div id="xp-bar-fill" class="xp-bar-fill"></div>
          </div>
          <div class="xp-text">
            <span class="xp-label">Farming XP:</span>
            <span id="xp-current">0</span> / <span id="xp-needed">100</span>
          </div>
        </div>
      </div>

      <div id="farm-grid" class="farm-grid"></div>

      <div class="farm-actions">
        <button id="plant-all-btn" class="btn btn-success" data-i18n="farm.plantAll">
          <span>üå±</span> Plantar<br>Tudo
        </button>
        <button id="harvest-all-btn" class="btn btn-primary" data-i18n="farm.harvestAll">
          <span>üß∫</span> Colher<br>Tudo
        </button>
      </div>
    </div>

    <!-- Skills Screen -->
    <div id="skills-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/skills.png" alt="Skills" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="skills.title">Suas Habilidades</span></h2>
      </div>
      <div id="skills-grid" class="skills-grid"></div>
    </div>

    <!-- Inventory Screen -->
    <div id="inventory-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/bolsa.png" alt="Invent√°rio" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="inventory.title">Invent√°rio</span></h2>
      </div>
      <div id="inventory-grid" class="inventory-grid"></div>
    </div>

    <!-- City Screen -->
    <div id="city-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/cidade.png" alt="Cidade" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="city.title">Cidade</span></h2>
      </div>
      <div class="city-grid">
        <div class="city-card" data-location="market">
          <div class="city-icon"><img src="assets/sprites/mercado.png" alt="Mercado" style="width: 48px; height: 48px;"></div>
          <h3 data-i18n="market.title">Mercado</h3>
          <p data-i18n="city.marketDesc">Compre e venda itens</p>
        </div>
        <div class="city-card" data-location="bank">
          <div class="city-icon"><img src="assets/sprites/banco.png" alt="Banco" style="width: 48px; height: 48px;"></div>
          <h3 data-i18n="city.bank">Banco</h3>
          <p data-i18n="city.bankDesc">Gerencie seu dinheiro</p>
        </div>
        <div class="city-card" data-location="tavern">
          <div class="city-icon"><img src="assets/sprites/taverna.png" alt="Taverna" style="width: 48px; height: 48px;"></div>
          <h3 data-i18n="city.tavern">Taverna</h3>
          <p data-i18n="city.tavernDesc">Descanse e ou√ßa hist√≥rias</p>
        </div>
        <div class="city-card" data-location="plaza">
          <div class="city-icon"><img src="assets/sprites/praca.png" alt="Pra√ßa" style="width: 48px; height: 48px;"></div>
          <h3 data-i18n="city.plaza">Pra√ßa</h3>
          <p data-i18n="city.plazaDesc">Centro da cidade</p>
        </div>
      </div>
    </div>

    <!-- Market Screen -->
    <div id="market-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/mercado.png" alt="Mercado" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="market.title">Mercado</span></h2>
      </div>
      <div id="market-grid" class="market-grid"></div>
    </div>

    <!-- Quests Screen -->
    <div id="quests-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/quests.png" alt="Miss√µes" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="quests.title">Miss√µes</span></h2>
      </div>
      <div id="quests-list" class="quests-list"></div>
    </div>

    <!-- NPCs Screen -->
    <div id="npcs-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/npcs.png" alt="NPCs" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="npcs.title">NPCs</span></h2>
      </div>
      <div id="npcs-grid" class="npcs-grid"></div>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/settings.png" alt="Configura√ß√µes" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="settings.title">Configura√ß√µes</span></h2>
      </div>

      <div class="settings-container">
        <div class="setting-group">
          <h3 data-i18n="settings.theme">Tema</h3>
          <div class="theme-selector">
            <button class="theme-btn" data-theme="light">
              <span>‚òÄÔ∏è</span>
              <span data-i18n="settings.lightTheme">Dia</span>
            </button>
            <button class="theme-btn" data-theme="dark">
              <span>üåô</span>
              <span data-i18n="settings.darkTheme">Noite</span>
            </button>
          </div>
        </div>

        <div class="setting-group">
          <h3 data-i18n="settings.language">Idioma</h3>
          <div class="language-selector">
            <button class="lang-btn" data-lang="pt-BR">
              <span>üáßüá∑</span>
              <span>Portugu√™s (BR)</span>
            </button>
            <button class="lang-btn" data-lang="en-US">
              <span>üá∫üá∏</span>
              <span>English (US)</span>
            </button>
          </div>
        </div>

        <div class="setting-group">
          <h3 data-i18n="settings.notifications">Notifica√ß√µes</h3>
          <p class="setting-description" data-i18n="settings.notificationsDesc">
            Receba avisos quando seus crops estiverem prontos para colher
          </p>
          <button id="enable-notifications-btn" class="btn btn-primary" data-i18n="settings.enableNotifications">
            üîî Ativar Notifica√ß√µes
          </button>
          <button id="test-notification-btn" class="btn btn-secondary" data-i18n="settings.testNotification" style="display:none;">
            üß™ Testar Notifica√ß√£o
          </button>
          <div id="notification-status" style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);"></div>
        </div>

        <div class="setting-group">
          <h3 data-i18n="settings.data">Dados do Jogo</h3>
          <button id="save-file-btn" class="btn btn-secondary" data-i18n="settings.save">
            üíæ Salvar Jogo
          </button>
          <button id="load-file-btn" class="btn btn-secondary" data-i18n="settings.load">
            üìÇ Carregar Jogo
          </button>
          <button id="reset-game-btn" class="btn btn-danger" data-i18n="settings.reset">
            üóëÔ∏è Resetar Jogo
          </button>
        </div>
      </div>
    </div>

    <!-- Wiki Screen -->
    <div id="wiki-screen" class="screen">
      <div class="screen-header">
        <h2><img src="assets/sprites/wiki.png" alt="Wiki" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"><span data-i18n="wiki.title">Wiki - Guia Completo</span></h2>
      </div>

      <div class="wiki-container">
        <!-- Wiki Sidebar -->
        <div class="wiki-sidebar">
          <div class="wiki-search">
            <input type="text" id="wiki-search" placeholder="Buscar na Wiki..." class="wiki-search-input">
            <span class="wiki-search-icon">üîç</span>
          </div>

          <nav class="wiki-nav">
            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.startSection">üéÆ In√≠cio</h3>
              <button class="wiki-nav-item active" data-wiki-page="getting-started">
                <span class="wiki-nav-icon">üå±</span>
                <span data-i18n="wiki.nav.gettingStarted">Primeiros Passos</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="game-mechanics">
                <span class="wiki-nav-icon">‚öôÔ∏è</span>
                <span data-i18n="wiki.nav.gameMechanics">Como Jogar</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="energy-system">
                <span class="wiki-nav-icon">‚ö°</span>
                <span data-i18n="wiki.nav.energySystem">Sistema de Energia</span>
              </button>
            </div>

            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.farmingSection">üåæ Farming</h3>
              <button class="wiki-nav-item" data-wiki-page="crops">
                <span class="wiki-nav-icon">üåΩ</span>
                <span data-i18n="wiki.nav.crops">Cultivos</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="tools">
                <span class="wiki-nav-icon">üîß</span>
                <span data-i18n="wiki.nav.tools">Ferramentas</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="fertilizer">
                <span class="wiki-nav-icon">üåø</span>
                <span data-i18n="wiki.nav.fertilizer">Fertilizantes</span>
              </button>
            </div>

            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.skillsSection">‚≠ê Skills</h3>
              <button class="wiki-nav-item" data-wiki-page="skills-system">
                <span class="wiki-nav-icon">üìä</span>
                <span data-i18n="wiki.nav.skillsSystem">Sistema de Skills</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="leveling">
                <span class="wiki-nav-icon">üéØ</span>
                <span data-i18n="wiki.nav.leveling">N√≠veis e XP</span>
              </button>
            </div>

            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.itemsSection">üì¶ Itens</h3>
              <button class="wiki-nav-item" data-wiki-page="items-guide">
                <span class="wiki-nav-icon">üéí</span>
                <span data-i18n="wiki.nav.itemsGuide">Guia de Itens</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="all-items">
                <span class="wiki-nav-icon">üìã</span>
                <span data-i18n="wiki.nav.allItems">Lista Completa</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="inventory">
                <span class="wiki-nav-icon">üëú</span>
                <span data-i18n="wiki.nav.inventory">Invent√°rio</span>
              </button>
            </div>

            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.citySection">üèòÔ∏è Cidade</h3>
              <button class="wiki-nav-item" data-wiki-page="market">
                <span class="wiki-nav-icon">üè™</span>
                <span data-i18n="wiki.nav.market">Mercado</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="npcs-guide">
                <span class="wiki-nav-icon">üë•</span>
                <span data-i18n="wiki.nav.npcsGuide">NPCs</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="quests">
                <span class="wiki-nav-icon">üìú</span>
                <span data-i18n="wiki.nav.quests">Miss√µes</span>
              </button>
            </div>

            <div class="wiki-nav-section">
              <h3 class="wiki-nav-title" data-i18n="wiki.nav.tipsSection">üí° Dicas</h3>
              <button class="wiki-nav-item" data-wiki-page="tips">
                <span class="wiki-nav-icon">üíé</span>
                <span data-i18n="wiki.nav.tips">Dicas e Truques</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="strategies">
                <span class="wiki-nav-icon">üéØ</span>
                <span data-i18n="wiki.nav.strategies">Estrat√©gias</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="faq">
                <span class="wiki-nav-icon">‚ùì</span>
                <span data-i18n="wiki.nav.faq">Perguntas Frequentes</span>
              </button>
              <button class="wiki-nav-item" data-wiki-page="updates">
                <span class="wiki-nav-icon">üì∞</span>
                <span data-i18n="wiki.nav.updates">Atualiza√ß√µes</span>
              </button>
            </div>
          </nav>
        </div>

        <!-- Wiki Content - Dynamically generated by WikiManager -->
        <div class="wiki-content">
          <div class="wiki-loading">
            <p>Carregando conte√∫do da wiki...</p>
          </div>
        </div>
      </div>
    </div>


  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-row">
      <div class="footer-brand">
        <span class="footer-game-name">üåæ FazendaRPG</span>
        <span class="footer-copyright">¬© 2025</span>
      </div>
      <div class="footer-dev">
        <span class="footer-dev-text" data-i18n="footer.developed">Desenvolvido por:</span>
        <a href="https://gennisys.com" target="_blank" rel="noopener noreferrer" class="gennisys-badge">
          <span class="gennisys-text">Gennisys</span>
        </a>
      </div>
      <div class="footer-version-card">
        <span class="version-number">v0.0.17</span>
      </div>
    </div>
  </footer>

  <!-- Avatar Selection Modal -->
  <div id="avatar-modal" class="modal-container">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Escolha seu Avatar</h2>
        <button class="modal-close-btn" id="avatar-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="avatar-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
          <!-- Avatars will be dynamically loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container" class="modal-container"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <!-- Logo/Icon -->
      <div class="loading-logo">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #5caa1f 0%, #7ec850 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; box-shadow: 0 4px 20px rgba(92, 170, 31, 0.5);">üåæ</div>
      </div>

      <!-- Game Title -->
      <h1 class="loading-title">üåæ FazendaRPG</h1>

      <!-- Progress Bar -->
      <div class="loading-progress-container">
        <div class="loading-progress-bar" id="loading-progress-bar">
          <div class="loading-progress-shine"></div>
        </div>
        <div class="loading-progress-text" id="loading-progress-text">0%</div>
      </div>

      <!-- Loading Message -->
      <p class="loading-message" id="loading-message" data-i18n="loading">Preparando a fazenda...</p>

      <!-- Loading Steps (hidden by default) -->
      <div class="loading-steps" id="loading-steps" style="display: none;">
        <div class="loading-step">üì¶ Carregando recursos...</div>
      </div>

      <!-- Timeout Warning -->
      <div id="loading-timeout-warning" class="loading-timeout-warning" style="display: none;">
        <div class="timeout-icon">‚ö†Ô∏è</div>
        <p class="timeout-title">Carregamento Demorado</p>
        <p class="timeout-description">O jogo est√° demorando mais que o esperado. Tente uma das op√ß√µes abaixo:</p>
        <div class="timeout-buttons">
          <button onclick="forceReloadApp()" class="timeout-btn timeout-btn-primary">
            <span class="btn-icon">üîÑ</span>
            <span class="btn-text">Recarregar</span>
          </button>
          <button onclick="clearCacheAndReload()" class="timeout-btn timeout-btn-danger">
            <span class="btn-icon">üóëÔ∏è</span>
            <span class="btn-text">Limpar Cache</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- iOS Loading Fix Script -->
  <script>
    // Detect iOS (shared globally)
    window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // Loading progress tracking
    let loadingTimeout;
    let gameLoaded = false;
    let currentProgress = 0;
    const totalSteps = 18; // Total loading steps from GameEngine

    // Loading messages for each step
    const loadingMessages = [
      'üåç Preparando o mundo...',
      'üìö Carregando tradu√ß√µes...',
      'üë§ Criando seu personagem...',
      '‚ö° Configurando habilidades...',
      'üîî Ativando notifica√ß√µes...',
      'üéí Preparando invent√°rio...',
      'üåæ Cultivando a fazenda...',
      'üìú Carregando miss√µes...',
      'üéâ Configurando eventos...',
      'üñºÔ∏è Construindo interface...',
      'üì¶ Organizando itens...',
      'üè™ Abrindo o mercado...',
      'ü§ù Conhecendo os NPCs...',
      'üèòÔ∏è Preparando a cidade...',
      'üìñ Carregando a wiki...',
      'üé® Configurando avatares...',
      'üì∞ Buscando not√≠cias...',
      '‚ú® Adicionando anima√ß√µes...',
      'üéÆ Finalizando...'
    ];

    // Update loading progress
    window.updateLoadingProgress = function(step, message) {
      const progressBar = document.getElementById('loading-progress-bar');
      const progressText = document.getElementById('loading-progress-text');
      const messageEl = document.getElementById('loading-message');

      if (!progressBar || !progressText || !messageEl) return;

      // Calculate progress percentage
      const progress = Math.min(Math.round((step / totalSteps) * 100), 100);

      // Smooth transition
      setTimeout(() => {
        progressBar.style.width = progress + '%';
        progressText.textContent = progress + '%';

        // Use custom message or default from array
        const displayMessage = message || loadingMessages[step] || 'Carregando...';
        messageEl.textContent = displayMessage;

        // Add pulse animation
        messageEl.style.animation = 'none';
        setTimeout(() => {
          messageEl.style.animation = 'fadeInUp 0.5s ease-out';
        }, 10);
      }, 50);
    };

    function startLoadingTimeout() {
      loadingTimeout = setTimeout(() => {
        if (!gameLoaded) {
          console.warn('‚ö†Ô∏è Loading timeout detected! Showing recovery options...');
          const warningDiv = document.getElementById('loading-timeout-warning');
          const stepsDiv = document.getElementById('loading-steps');
          if (warningDiv) {
            warningDiv.style.display = 'block';
          }
          if (stepsDiv) {
            stepsDiv.style.display = 'none';
          }
        }
      }, 10000); // 10 seconds
    }

    function clearLoadingTimeout() {
      gameLoaded = true;
      if (loadingTimeout) {
        clearTimeout(loadingTimeout);
      }
    }

    function forceReloadApp() {
      console.log('üîÑ Force reloading app...');
      window.location.reload(true);
    }

    async function clearCacheAndReload() {
      console.log('üóëÔ∏è Clearing all caches...');

      // Show clearing message
      const messageEl = document.getElementById('loading-message');
      if (messageEl) {
        messageEl.textContent = 'üóëÔ∏è Limpando cache...';
      }

      // Clear Service Worker caches
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        console.log('‚úÖ Caches cleared');
      }

      // Unregister Service Worker
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(reg => reg.unregister()));
        console.log('‚úÖ Service Workers unregistered');
      }

      // Clear localStorage flag
      localStorage.removeItem('sw_failed');

      // Reload
      window.location.reload(true);
    }

    // Start with initial progress
    window.updateLoadingProgress(0, 'üåæ Iniciando FazendaRPG...');

    // Start timeout
    startLoadingTimeout();

    // Listen for successful game load
    window.addEventListener('gameLoaded', () => {
      clearLoadingTimeout();
      window.updateLoadingProgress(totalSteps, '‚úÖ Pronto para jogar!');

      // Hide loading overlay after a short delay
      setTimeout(() => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 300);
        }
      }, 500);
    });

    // Expose functions globally
    window.forceReloadApp = forceReloadApp;
    window.clearCacheAndReload = clearCacheAndReload;
  </script>

  <!-- Scripts -->
  <script type="module" src="js/app.js"></script>

  <!-- Service Worker Registration with iOS fix -->
  <script>
    // Use the globally defined isIOS
    const swFailed = localStorage.getItem('sw_failed') === 'true';

    // On iOS, if Service Worker failed before, skip it
    if ('serviceWorker' in navigator && !(window.isIOS && swFailed)) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', {
          updateViaCache: 'none' // Disable caching for SW script itself on iOS
        })
          .then(reg => {
            console.log('‚úÖ Service Worker registered');
            localStorage.removeItem('sw_failed');
          })
          .catch(err => {
            console.error('‚ùå SW registration failed:', err);
            if (window.isIOS) {
              console.warn('‚ö†Ô∏è iOS detected - marking SW as failed, will skip on next load');
              localStorage.setItem('sw_failed', 'true');
            }
          });
      });
    } else if (window.isIOS && swFailed) {
      console.log('‚ÑπÔ∏è iOS: Skipping Service Worker due to previous failure');
    }
  </script>
</body>
</html>
